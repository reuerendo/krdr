name: Build KOReader for PocketBook (Custom crengine)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Prepare the environment
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git devscripts build-essential ccache grep

      # Step 2: Checkout the main repository (Shallow clone to save time)
      - name: Checkout KOReader
        uses: actions/checkout@v4
        with:
          repository: koreader/koreader
          fetch-depth: 1

      # Step 3: Manually initialize the 'base' submodule
      # This is where the Makefile.thirdparty resides.
      - name: Initialize koreader-base submodule
        run: |
          echo "Initializing the base submodule..."
          git submodule update --init --depth 1 base

      # Step 4: Locate and modify the crengine configuration
      # We target base/Makefile.thirdparty specifically.
      - name: Swap crengine repository to custom fork
        run: |
          # The file is located in the 'base' directory which is a submodule
          CONFIG_FILE="base/Makefile.thirdparty"
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "Found $CONFIG_FILE. Patching..."
            
            # 1. Replace the repository URL
            sed -i 's|https://github.com/koreader/crengine|https://github.com/reuerendo/crengine|g' "$CONFIG_FILE"
            
            # 2. Change the Revision to master to pull your latest changes
            # By default KOReader uses a specific git hash.
            sed -i 's/CRENGINE_REV:=.*/CRENGINE_REV:=master/g' "$CONFIG_FILE"
            
            echo "Successfully patched. Current values:"
            grep -E "CRENGINE_URL|CRENGINE_REV" "$CONFIG_FILE"
          else
            echo "ERROR: $CONFIG_FILE not found!"
            echo "Listing contents of 'base' directory for debugging:"
            ls -la base
            exit 1
          fi

      # Step 5: Build the PocketBook package
      # This will take a significant amount of time (40-60 minutes)
      - name: Build KOReader (PocketBook)
        run: |
          # We use the 'pocketbook' target. 
          # This command automatically handles Docker and toolchains.
          ./kodev build pocketbook

      # Step 6: Upload the resulting installation package
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: koreader-pocketbook-custom-crengine
          path: ./dist/koreader-pocketbook-*.zip
          if-no-files-found: error
