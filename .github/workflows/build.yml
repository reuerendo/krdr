name: Build KOReader for PocketBook (Custom crengine)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Install system dependencies
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git devscripts build-essential ccache

      # Step 2: Checkout the main KOReader repository
      - name: Checkout KOReader
        uses: actions/checkout@v4
        with:
          repository: koreader/koreader
          # We will initialize submodules manually to control the crengine source
          fetch-depth: 1

      # Step 3: Patch .gitmodules in the 'base' directory
      # This file defines the 'kpvcrlib/crengine' submodule 
      - name: Patch crengine URL
        run: |
          echo "Patching base/.gitmodules..."
          # Update the submodule URL to point to your fork 
          sed -i 's|https://github.com/koreader/crengine.git|https://github.com/reuerendo/crengine.git|g' base/.gitmodules
          
          # Sync the changes with git configuration
          cd base
          git submodule sync
          cd ..
          
          echo "Verification of .gitmodules content:"
          grep "url =" base/.gitmodules

      # Step 4: Initialize all submodules
      # This will follow the new URL from .gitmodules
      - name: Initialize submodules
        run: |
          git submodule update --init --recursive --depth 1

      # Step 5: Force crengine to use the 'master' branch of your fork
      # By default, git submodules pin a specific commit. We want your latest code.
      - name: Switch crengine to master branch
        run: |
          cd base/thirdparty/kpvcrlib/crengine
          git fetch origin master
          git checkout master
          cd ../../../..

      # Step 6: Build the application for PocketBook
      # The 'pocketbook' target handles the cross-compilation environment
      - name: Build KOReader (PocketBook)
        run: |
          ./kodev build pocketbook

      # Step 7: Upload the finished ZIP package
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: koreader-pocketbook-custom
          path: ./dist/koreader-pocketbook-*.zip
          if-no-files-found: error
