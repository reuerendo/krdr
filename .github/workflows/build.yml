name: Build KOReader for PocketBook (Deep Search Patch)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Maximize disk space (KOReader builds are heavy)
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      # Step 2: Install host tools
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git devscripts build-essential ccache grep xargs

      # Step 3: Checkout with all submodules
      - name: Checkout KOReader
        uses: actions/checkout@v4
        with:
          repository: koreader/koreader
          submodules: recursive
          fetch-depth: 0

      # Step 4: Search and replace crengine URL and Revision everywhere
      - name: Patch crengine fork
        run: |
          echo "Searching for crengine URL in the entire project..."
          
          # We search for the string and replace it in any file it appears
          # This handles changes in directory structure automatically
          grep -rl "github.com/koreader/crengine" . | xargs sed -i 's|github.com/koreader/crengine|github.com/reuerendo/crengine|g'
          
          # Also search for the revision variable. 
          # It's usually CRENGINE_REV or CRENGINE_COMMIT.
          # We force it to 'master' to use your latest changes.
          grep -rl "CRENGINE_REV" . | xargs sed -i 's/CRENGINE_REV:=.*/CRENGINE_REV:=master/g' || true
          
          echo "Patching complete. Verifying changes..."
          # Verify by searching again (should show your fork now)
          grep -r "github.com/reuerendo/crengine" .

      # Step 5: Build for PocketBook
      - name: Build KOReader (PocketBook)
        run: |
          # Increase Git buffer size for large submodules
          git config --global http.postBuffer 524288000
          ./kodev build pocketbook

      # Step 6: Upload the resulting ZIP
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: koreader-pocketbook-custom
          path: ./dist/koreader-pocketbook-*.zip
          if-no-files-found: error
