name: Build KOReader for PocketBook (Custom crengine)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Install essential host tools
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git devscripts build-essential ccache grep

      # Step 2: Checkout the main repository with all submodules
      # Using submodules: recursive is critical for KOReader
      - name: Checkout KOReader
        uses: actions/checkout@v4
        with:
          repository: koreader/koreader
          submodules: recursive
          fetch-depth: 0

      # Step 3: Dynamically find and modify the crengine configuration
      # This approach is safer than hardcoding paths
      - name: Swap crengine repository to custom fork
        run: |
          echo "Searching for the file containing CRENGINE_URL..."
          
          # Find the file that defines the crengine URL (usually base/Makefile.thirdparty)
          TARGET_FILE=$(grep -rl "CRENGINE_URL" . | head -n 1)
          
          if [ -n "$TARGET_FILE" ]; then
            echo "Found configuration file at: $TARGET_FILE"
            
            # Replace the official repository with your fork
            sed -i 's|https://github.com/koreader/crengine|https://github.com/reuerendo/crengine|g' "$TARGET_FILE"
            
            # Force the build system to use the master branch of your fork
            # This ensures your latest changes are included
            sed -i 's/CRENGINE_REV:=.*/CRENGINE_REV:=master/g' "$TARGET_FILE"
            
            echo "Verification of the changes in $TARGET_FILE:"
            grep "CRENGINE_URL" "$TARGET_FILE"
            grep "CRENGINE_REV" "$TARGET_FILE"
          else
            echo "Error: Could not find any file containing CRENGINE_URL"
            exit 1
          fi

      # Step 4: Run the build process using the kodev tool
      - name: Build KOReader (PocketBook)
        run: |
          # The 'pocketbook' target triggers the cross-compilation for PB devices.
          # This process runs inside a specialized Docker container.
          ./kodev build pocketbook

      # Step 5: Archive the resulting ZIP file
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: koreader-pocketbook-custom
          # The build result is placed in the 'dist' directory
          path: ./dist/koreader-pocketbook-*.zip
          if-no-files-found: error
