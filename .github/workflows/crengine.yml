name: Build CREngine for PocketBook

on:
  workflow_dispatch:

jobs:
  build-crengine:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout crengine repository
        uses: actions/checkout@v4
        with:
          repository: reuerendo/crengine
          ref: fit-content
          fetch-depth: 1
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            build-essential \
            cmake \
            curl \
            file \
            git \
            libtool \
            nasm \
            patch \
            pkg-config \
            wget \
            zlib1g-dev \
            libpng-dev \
            libjpeg-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libunibreak-dev \
            libutf8proc-dev \
            libzstd-dev
      
      - name: Download and install PocketBook toolchain
        run: |
          cd $HOME
          wget https://github.com/koreader/koxtoolchain/releases/download/2025.05/pocketbook.tar.gz
          tar -xzf pocketbook.tar.gz
      
      - name: Setup toolchain environment
        run: |
          echo "$HOME/x-tools/arm-pocketbook-linux-gnueabi/bin" >> $GITHUB_PATH
      
      - name: Configure CREngine with CMake
        working-directory: ${{ github.workspace }}
        run: |
          export PATH="$HOME/x-tools/arm-pocketbook-linux-gnueabi/bin:$PATH"
          export CROSS_TC="arm-pocketbook-linux-gnueabi"
          
          mkdir -p build
          cd build
          cmake \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=arm \
            -DCMAKE_C_COMPILER=${CROSS_TC}-gcc \
            -DCMAKE_CXX_COMPILER=${CROSS_TC}-g++ \
            -DCMAKE_FIND_ROOT_PATH=$HOME/x-tools/${CROSS_TC}/${CROSS_TC}/sysroot \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local/pocketbook/mnt/ext1 \
            -DGUI=CRGUI_PB \
            -DDEVICE_NAME=pocketbook \
            -DMAX_IMAGE_SCALE_MUL=2 \
            -DENABLE_CHM=1 \
            -DENABLE_ANTIWORD=1 \
            -DZLIB_FOUND=FALSE \
            -DPNG_FOUND=FALSE \
            -DJPEG_FOUND=FALSE \
            -DFREETYPE_FOUND=FALSE \
            -DHARFBUZZ_FOUND=FALSE \
            -DFRIBIDI_FOUND=FALSE \
            -DLIBUNIBREAK_FOUND=FALSE \
            -DUTF8PROC_FOUND=FALSE \
            -DCMAKE_CXX_FLAGS_RELEASE:STRING="-fomit-frame-pointer -O1" \
            ..
      
      - name: Build CREngine
        working-directory: ${{ github.workspace }}/build
        run: |
          make -j$(nproc) VERBOSE=1
      
      - name: Display build artifacts
        working-directory: ${{ github.workspace }}/build
        run: |
          echo "=== Build artifacts ==="
          find . -type f -name "*.so" -o -name "*.a" -o -name "cr3"
          echo "=== Build complete ==="
      
      - name: Package build artifacts
        working-directory: ${{ github.workspace }}/build
        run: |
          mkdir -p artifacts
          find . -type f \( -name "*.so" -o -name "*.a" -o -name "cr3" \) -exec cp {} artifacts/ \;
          tar -czf crengine-pocketbook.tar.gz artifacts/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crengine-pocketbook
          path: build/crengine-pocketbook.tar.gz
          if-no-files-found: error
      
      - name: Create release on tags
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/crengine-pocketbook.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
